# Drift Development Notes

## Rules

- **Menu + Hotkey**: Every new functionality that has a keyboard shortcut must also be added to the app menu, with the hotkey displayed in the menu item.

## Development Workflow

- **After TypeScript changes**: Run `npx tsc --noEmit` to catch type errors before telling the user it's ready.
- **Check dev server output**: Tail the background task output file to catch compile/runtime errors after changes.

## Claude Agent Workflow

This repo has automated workflows that let Claude fix issues and respond to PR feedback.

### How It Works

1. **Issue → PR**: Add the `claude` label to an issue → Claude creates a fix and opens a PR with demo GIF
2. **PR Feedback**: Comment `@claude <feedback>` on a PR → Claude adjusts the implementation

### File Organization

All artifacts for an issue go in `e2e/issues/<issue-number>/`:

```
e2e/issues/123/
├── verify.spec.ts      # Test that captures before/after screenshots
├── demo.spec.ts        # Test that records the demo video
├── screenshots/
│   ├── before.png      # State before fix (NEVER overwrite during adjustments)
│   └── after.png       # State after fix
├── demo.gif            # Generated by fix script (don't create manually)
└── pr-body.md          # PR description markdown
```

### Running Locally

```bash
# Fix a new issue
npm run fix -- --issue 123 "Issue title and description"

# Adjust an existing PR
npm run fix -- --pr 8 "Make the animation smoother"

# Ad-hoc local testing (no GitHub issue)
npm run fix -- "Add a cool feature"
```

### Writing Tests

**Verification test** (`verify.spec.ts`):
```typescript
import { test, expect } from '@playwright/test'
import { getTauriMockScript } from '../../tauri-mocks'
import * as path from 'path'

const SCREENSHOTS_DIR = path.join(path.dirname(import.meta.url.replace('file://', '')), 'screenshots')

test.beforeEach(async ({ page }) => {
  await page.addInitScript(getTauriMockScript())
})

test('verify issue', async ({ page }) => {
  await page.goto('/')
  await expect(page.locator('.cm-editor')).toBeVisible()

  // Setup and capture screenshot
  await page.screenshot({ path: path.join(SCREENSHOTS_DIR, 'before.png') })
})
```

**Demo test** (`demo.spec.ts`):
```typescript
test('demo: feature in action', async ({ page }) => {
  test.slow()
  await page.setViewportSize({ width: 600, height: 450 })
  await page.goto('/')

  // Show the feature with realistic interactions
  await page.keyboard.type('Hello world', { delay: 40 })
  await page.waitForTimeout(500)
})
```

### Critical Rules

1. **Don't convert videos to GIF** - The fix script handles this automatically. Just output the video path.
2. **Don't overwrite before.png during adjustments** - It must always show the original state.
3. **Don't manually start the dev server** - Playwright's webServer config handles this.
4. **Always capture visual evidence** - Even "non-visual" changes need proof (console, devtools, etc).

### Visual Assertions

Use `assertScreenshot()` to verify screenshots with AI:

```typescript
import { assertScreenshot } from '../../helpers/screenshots'

const result = await assertScreenshot(page, 'The title should be blue')
// Returns: { pass: true/false, reason: "..." }
```

If the assertion seems wrong, DON'T work around it. Report an assertion bug instead.

### Output Format

When done, output a PR block in this exact format:

```
---PR---
title: Short title under 70 chars
status: success
issue_id: 123
demo_video: test-results/.../video.webm

## Demo
(leave for GIF insertion)

## Summary
What was fixed and how.

## Before & After
| Before | After |
|--------|-------|
| ![before](e2e/issues/123/screenshots/before.png) | ![after](e2e/issues/123/screenshots/after.png) |
---END---
```
